<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FEWS-3Di integration &mdash; 3Di  (dev doc 2023-03-20) documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script src="_static/matomo.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tutorial 1: Workflow of creating a 3Di Schematisation and a 3Di Model" href="e_klondike_workflow.html" />
    <link rel="prev" title="3Di API" href="b_api.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            3Di
          </a>
              <div class="version">
                 (dev doc 2023-03-20)
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="a_background.html">Background of 3Di</a></li>
<li class="toctree-l1"><a class="reference internal" href="a_ecosystem.html">3Di Ecosystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="a_modelling_concepts.html">Basic Modelling Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="a_releasenotes.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="a_contact.html">Contact</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">3Di Connectors</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">FEWS-3Di integration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#procedure">Procedure</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#select-3di-model">Select 3Di model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-simulation">Create simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-initial-conditions-optional">Add initial conditions (optional)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-forcings-mandatory">Add forcings (mandatory)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#start-simulation">Start simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#follow-progress">Follow progress</a></li>
<li class="toctree-l3"><a class="reference internal" href="#check-simulation-state">Check simulation state</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get-results">Get results</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get-saved-states-identifiers">Get saved states identifiers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#implementation">Implementation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#general-information">General information</a></li>
<li class="toctree-l3"><a class="reference internal" href="#starting-points">Starting points</a></li>
<li class="toctree-l3"><a class="reference internal" href="#grid-definition">Grid definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#general-adapter">General adapter</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#installation-of-adapter">Installation of adapter</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Guide to the 3Di Modeller Interface</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="i_what_is_mi.html">What is the Modeller Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="i_overview_user_interface.html">Overview of the Modeller Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="i_modelling_with_mi.html">Modelling with the Modeller Interface</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Guide to the 3Di Live Site</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="c_what_is_the_live_site.html">What is the 3Di Live Site</a></li>
<li class="toctree-l1"><a class="reference internal" href="c_what_is_the_live_site.html#di-livesite">3Di Livesite</a></li>
<li class="toctree-l1"><a class="reference internal" href="c_livesite_overview.html">Overview of the 3Di Live Site</a></li>
<li class="toctree-l1"><a class="reference internal" href="c_modelling_with_live_site.html">Modelling with the 3Di Live Site</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="e_klondike_workflow.html">Tutorial 1: Workflow of creating a 3Di Schematisation and a 3Di Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="e_2d_tutorial.html">Tutorial 2: Building a Basic 2D Flow Schematisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="e_2d_slope_tutorial.html">Tutorial 3: 2D flow model over sloped terrain with multiple rasters</a></li>
<li class="toctree-l1"><a class="reference internal" href="e_2d_levees_tutorial.html">Tutorial 4 Building a 2D flow model with levees, channels and breaches</a></li>
<li class="toctree-l1"><a class="reference internal" href="e_1d_tutorial.html">Tutorial 5: Building a 1D model</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Problem solving and support</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="f_3di_instruments_and_downloads.html">Installation manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_problem_solving.html">FAQ and Problem Solving</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_servicedesk.html">Servicedesk</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="g_massconservation.html">Conservation of mass</a></li>
<li class="toctree-l1"><a class="reference internal" href="g_flow.html">Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="g_sources_sinks.html">Source and Sink terms</a></li>
<li class="toctree-l1"><a class="reference internal" href="g_levees_obstacles_breaches.html">Obstacles, Levees and Breaches</a></li>
<li class="toctree-l1"><a class="reference internal" href="g_wind.html">Wind effects</a></li>
<li class="toctree-l1"><a class="reference internal" href="g_interception.html">Interception</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Model concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="h_basic_modelling_concepts_threedi.html">Basic Modelling Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="h_grid.html">The grid</a></li>
<li class="toctree-l1"><a class="reference internal" href="h_numerics.html">Numerics</a></li>
<li class="toctree-l1"><a class="reference internal" href="h_control.html">Control Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="h_calculation_grid_data.html">Tabulated data storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="h_results.html">Results 3Di</a></li>
<li class="toctree-l1"><a class="reference internal" href="h_aggregate_results.html">Aggregated output</a></li>
<li class="toctree-l1"><a class="reference internal" href="h_state_files.html">State files</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">3Di</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">FEWS-3Di integration</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/b_fews_3di_integrations.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="fews-3di-integration">
<span id="b-fews-integration"></span><h1>FEWS-3Di integration<a class="headerlink" href="#fews-3di-integration" title="Permalink to this heading"></a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h2>
<p>Since 2019 the 3Di Hydrodynamic Simulation Software contains a new setup of the 3Di API.
This API version 3 is developed with the goal to fully support interaction with other applications, from setting up a calculation to retrieving the simulation results.
There are already some applications which interact with 3Di;.e.g. ESRI ArcGIS and the 3Di livesite.</p>
<p>In the field of operational water management models are widely used to simulate the hydrological and hydrodynamic system.
Real-time control systems interact autonomously with models and use the simulation results to determine the desired control of structures.
Delft-FEWS, developed by Deltares, is one the most common software packages in operational water management.</p>
<p>For the integration of Delft-FEWS and 3Di an adapter is build.
This adapter provides functionalities to interact with 3Di from an operational Delft-FEWS system.</p>
<p>This document describes the functional and technical design of the FEWS-3Di integration and gives detailed information about the configuration in FEWS.</p>
<img alt="_images/d_fews_connector_01.png" src="_images/d_fews_connector_01.png" />
</section>
<section id="procedure">
<h2>Procedure<a class="headerlink" href="#procedure" title="Permalink to this heading"></a></h2>
<p>The following procedure describes the steps to start a simulation, set the initial condition, add forcings, follow the progress and retrieve the results.
The authorization for interaction with the 3Di API is based on a 3Di service account. This account is allowed to start simulations autonomously from external applications. The credentials will be part of the configuration of the operational system. All models available to the user of the 3Di account can be configured to run operationally.</p>
<section id="select-3di-model">
<h3>Select 3Di model<a class="headerlink" href="#select-3di-model" title="Permalink to this heading"></a></h3>
<p>Simulations can be started with 3Di models that are available to the user. A list of the available models can be found through the API or through <a class="reference external" href="https://management.3di.live/models">https://management.3di.live/models</a>. Every 3Di model has a unique identifier, which needs to be submitted when creating a new simulation.</p>
</section>
<section id="create-simulation">
<h3>Create simulation<a class="headerlink" href="#create-simulation" title="Permalink to this heading"></a></h3>
<p>To start a simulation, a simulation resource has to be created first. This simulation resource is created by sending simulation metadata through the API. The data consists of, among others, the unique identifier for the 3Di model that should be used, the organisation the simulation is requested for, the timespan of the simulation et cetera.
After creating a simulation, an unique identifier is obtained. This identifier is used to add initial conditions and/or forcings to the model simulation.</p>
</section>
<section id="add-initial-conditions-optional">
<h3>Add initial conditions (optional)<a class="headerlink" href="#add-initial-conditions-optional" title="Permalink to this heading"></a></h3>
<p>After a simulation has been created, initial conditions, like water levels or a saved flow state of a previous simulation can be added. The API provides a list of previous saved flow states for a 3Di model. These saved states all have an unique identifier which can be used to add them to the simulation. The simulation unique identifier needs to be submitted for every initial condition.</p>
</section>
<section id="add-forcings-mandatory">
<h3>Add forcings (mandatory)<a class="headerlink" href="#add-forcings-mandatory" title="Permalink to this heading"></a></h3>
<p>The API provides specific endpoints for different forcings/events. These events are coupled to the simulation by submitting them with the unique identifier of the simulation. Every event needs to be added via a separate API call.
The following events/forcings endpoints are currently available:</p>
<ul class="simple">
<li><p>Rain</p></li>
<li><p>Sources and sinks</p></li>
<li><p>Laterals</p></li>
</ul>
<p>For now adding at least one event is mandatory.</p>
</section>
<section id="start-simulation">
<h3>Start simulation<a class="headerlink" href="#start-simulation" title="Permalink to this heading"></a></h3>
<p>After the (optional) initial conditions are set and events are added to the simulation, the simulation is ready to run. A simulation is started by the adapter posting a new ‘start’ action to the /simulations/{id}/actions/ API endpoint.
After a simulation has been started, it cannot be started again. If you want to re-run the simulation you need to re-create it.</p>
</section>
<section id="follow-progress">
<h3>Follow progress<a class="headerlink" href="#follow-progress" title="Permalink to this heading"></a></h3>
<p>The API provides a /simulations/{id}/progress/ endpoint to check the progress of the simulation. It shows how far the calculation is in terms of the last calculated timestep and the total progress as a percentage.</p>
</section>
<section id="check-simulation-state">
<h3>Check simulation state<a class="headerlink" href="#check-simulation-state" title="Permalink to this heading"></a></h3>
<p>After (and during) the simulation, the latest state of the simulation can be retrieved via the api endpoint /simulations/{id}/states/latest/. After a successful run the latest state is ‘finished’ (or something similar). If the simulation crashed, the latest state is ‘crashed’ and provides information about the crash, if available.</p>
</section>
<section id="get-results">
<h3>Get results<a class="headerlink" href="#get-results" title="Permalink to this heading"></a></h3>
<p>Results can be retrieved via the /simulations/{id}/results/timeseries/ endpoint. This endpoint allows to provide filtering parameters for getting time series of a simulation. Under the hood it is going to provide a subset of the filtering/subset options provided by Threedigrid (<a class="reference external" href="https://threedigrid.readthedocs.io/en/latest/api.html#filtering">https://threedigrid.readthedocs.io/en/latest/api.html#filtering</a>). Threedigrid is a Python package created and maintained by Nelen &amp; schuurmans for interacting with 3Di model administration and 3Di model simulation results. The timeseries endpoint will provide access to time series of threedicore entities like calculation points, lines, grid cells et cetera.
The adapter makes it possible to easily retrieve the 1D or 2D results.</p>
</section>
<section id="get-saved-states-identifiers">
<h3>Get saved states identifiers<a class="headerlink" href="#get-saved-states-identifiers" title="Permalink to this heading"></a></h3>
<p>The simulation end state is available via the state/latest endpoint. An overview of all created saved states files is presented in the simulation end state including the unique identifiers of the saved state that can be used to set the initial state of an upcoming simulation via the API.</p>
</section>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading"></a></h2>
<section id="general-information">
<h3>General information<a class="headerlink" href="#general-information" title="Permalink to this heading"></a></h3>
<p>In this section the configuration of a 3Di model in FEWS is explained.
On this topic basic knowledge is assumed about coupling models in FEWS.
Otherwise general information can be found on the public wikipedia of Deltares (see link).
The sections below will focus on the aspects specific to the 3Di coupling, e.g. the conditions, grid definition and general adapter settings.</p>
</section>
<section id="starting-points">
<h3>Starting points<a class="headerlink" href="#starting-points" title="Permalink to this heading"></a></h3>
<p>Models coupled to FEWS systems are commonly installed on FEWS servers and can be run on the local machine.
3Di is a fully cloud-based and the simulations are performed in the cloud.
This implies FEWS needs to interact with the 3Di cloud.
One of the advantages of cloud modelling is that the FEWS servers don’t need to be equipped with extensive computer resources.
Also model maintenance is more straightforward, as a modeller can easily adjust the model in his personal working environment and upload it as a new revision.
It’s need to be noted that as a3Di model is running in the cloud the Forecasting Shell Servers of the FEWS systeem need to be connected to the internet.
The 3Di API is available at <a class="reference external" href="https://api.3di.live/">https://api.3di.live/</a>.</p>
</section>
<section id="grid-definition">
<h3>Grid definition<a class="headerlink" href="#grid-definition" title="Permalink to this heading"></a></h3>
<p>The quad-tree technology of 3Di uses a irregular grid to simulatie the water flow in two dimensions.
The irregular grid can be displayed in the FEWS system and project e.g. the water depths through time.
Below an example is shown. The grid can be created from a netcdf output file by using a function below the F12 menu in a FEWS client.</p>
<img alt="_images/d_fews_connector_02.png" src="_images/d_fews_connector_02.png" />
<p>The function generates a shapefile from the netcdf which can be used in a grid definition.
The shapefile can be added to the MapLayerFiles of the FEWS configuration and the grid can be defined in the Grids.xml.
Make sure also the location is defined in the Locations.xml.
For the definition of the location the actual coordinates are not relevant.
Below an example is given of a grid definition.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;irregular</span><span class="w"> </span><span class="na">locationId=</span><span class="s">&quot;3DI-TEXEL&quot;</span><span class="nt">&gt;</span>
<span class="w">     </span><span class="nt">&lt;esriShapeFile&gt;</span>
<span class="w">         </span><span class="nt">&lt;file&gt;</span>grid_2D_open_water.shp<span class="nt">&lt;/file&gt;</span>
<span class="w">         </span><span class="nt">&lt;geoDatum&gt;</span>Rijks<span class="w"> </span>Driehoekstelsel<span class="nt">&lt;/geoDatum&gt;</span>
<span class="w">         </span><span class="nt">&lt;x&gt;</span>%X%<span class="nt">&lt;/x&gt;</span>
<span class="w">         </span><span class="nt">&lt;y&gt;</span>%Y%<span class="nt">&lt;/y&gt;</span>
<span class="w">     </span><span class="nt">&lt;/esriShapeFile&gt;</span>
<span class="w"> </span><span class="nt">&lt;/irregular&gt;</span>
</pre></div>
</div>
<p>The defined locationId can be used in the GeneralAdapter and GridDisplay for the interaction with the 3Di model and presentation of the simulation results.</p>
</section>
<section id="general-adapter">
<h3>General adapter<a class="headerlink" href="#general-adapter" title="Permalink to this heading"></a></h3>
<p>The general adapter of a 3Di simulation will consist of three steps:</p>
<ol class="arabic simple">
<li><p>Preprocessing</p>
<ul class="simple">
<li><p>Defining the run information</p></li>
<li><p>Export forcings as input for the model</p></li>
<li><p>Defining the cold/warm initial conditions</p></li>
</ul>
</li>
<li><p>Start and follow the simulation</p>
<ul class="simple">
<li><p>Status</p></li>
<li><p>(Error) Logmessages</p></li>
</ul>
</li>
<li><p>Postprocessing</p>
<ul class="simple">
<li><p>Import time series of 1D elements (e.g. discharges of structures)</p></li>
<li><p>Import the calculated water depths of the 2D grid</p></li>
</ul>
</li>
</ol>
</section>
</section>
<section id="installation-of-adapter">
<h2>Installation of adapter<a class="headerlink" href="#installation-of-adapter" title="Permalink to this heading"></a></h2>
<p>The adapter is developed as a python package in Python3 and available in the Python Package system pip.
The package can easily be installed using the (windows) command:
<em>pyhon pip install fews-3di</em></p>
<p>As usual with installations of python modules, its recommended to install the package in a python virtual environment (also known as venv).
This prevents interference with other python installations and packages.</p>
<p>More information can be found at: <a class="reference external" href="https://pypi.org/project/fews-3di/">https://pypi.org/project/fews-3di/</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="b_api.html" class="btn btn-neutral float-left" title="3Di API" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="e_klondike_workflow.html" class="btn btn-neutral float-right" title="Tutorial 1: Workflow of creating a 3Di Schematisation and a 3Di Model" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Nelen &amp; Schuurmans.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>